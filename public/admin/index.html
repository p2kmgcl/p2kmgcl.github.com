<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      * {
        font-family: JetBrains Mono, Noto Sans Mono, Inconsolata, consolas,
          monospace !important;
      }
    </style>
  </head>
  <body>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <script
      src="https://unpkg.com/emoji-picker-element@^1.0.0/index.js"
      type="module"
    ></script>

    <script>
      const EmojiWidget = createClass({
        getInitialState() {
          this._picker = null;
          return { focused: false };
        },

        render: function () {
          return h(
            'div',
            {
              style: {
                position: 'relative',
              },
            },
            [
              h('input', {
                className: this.props.classNameWrapper,
                id: this.props.forID,
                type: 'text',
                readOnly: true,
                value: this.props.value || '',
                onFocus: () => {
                  this.setState({ focused: true });
                  this.props.setActiveStyle();
                },
              }),
              this.state.focused
                ? h(
                    'div',
                    {
                      style: {
                        position: 'absolute',
                        top: '100%',
                        left: 0,
                        zIndex: 9999,
                      },
                    },
                    h('emoji-picker', {
                      ref: (picker) => {
                        if (this._picker !== picker && picker) {
                          this._picker = picker;

                          picker.addEventListener('blur', () => {
                            this.props.setInactiveStyle();
                            this.setState({ focused: false });
                          });

                          picker.addEventListener('emoji-click', (event) => {
                            this.props.onChange(event.detail.unicode);
                            this.props.setInactiveStyle();
                            this.setState({ focused: false });
                          });
                        }
                      },
                    }),
                  )
                : null,
            ],
          );
        },
      });

      const TeseraPreview = createClass({
        componentDidMount() {
          this._iframeResizeIntervalId = setInterval(() => {
            if (this._iframe) {
              this._iframe.style.height =
                this._iframe.contentWindow.document.documentElement
                  .scrollHeight + 'px';
            }
          }, 1000);
        },

        componentWillUnmount() {
          clearInterval(this._iframeResizeIntervalId);
        },

        _setIframe(nextIframe) {
          this._iframe = nextIframe;
          this._syncProps();
        },

        _syncProps() {
          if (!this._iframe) return;

          const entryJSON = this.props.entry.toJSON();

          this._iframe.contentWindow.postMessage(
            JSON.stringify({
              ...entryJSON.data,
              slug: entryJSON.slug,
              type: 'entry',
            }),
            '*',
          );
        },

        render: function () {
          this._syncProps();

          return h(
            'iframe',
            {
              ref: (iframe) => this._setIframe(iframe),
              src: '/admin/preview-tesera',
            },
            null,
          );
        },
      });

      CMS.registerPreviewStyle('/admin/preview-tesera.css');
      CMS.registerPreviewTemplate('tesera', TeseraPreview);
      CMS.registerWidget('emoji', EmojiWidget);
    </script>
  </body>
</html>
