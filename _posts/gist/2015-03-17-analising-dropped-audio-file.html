---
title: Analysing dropped audio file
html_compiler: none
css_compiler: scss
js_compiler: none
---

<canvas class="c"></canvas>
<span class="output"></span>
<h1><!-- Audio name --></h1>
<h2>Drop an audio file</h2>

- - -

h1, h2 {
    font-weight: lighter;
    text-align: center;
    margin: 2em auto;
    color: white;
}

h2 {
    font-size: 1.25em;
    opacity: 0.5;
    color: white;
}

.output {
    font-size: 0.75em;
}

.c {
    position: absolute;
    left: 0; top: 0;
    width: 100%; height: 100%;
    box-shadow: inset 0 0 2em black;
    background-color: #1D1F20;
}

- - -

var output = SANDBOX_WRAPPER.querySelector('.output'),
    can = SANDBOX_WRAPPER.querySelector('.c'),
    ctx = can.getContext('2d'),

    player = document.createElement('audio'),
    audio = document.createElement('audio'),
    context = new AudioContext(),
    analyser = context.createAnalyser(),
    animationFrame = null;

    SANDBOX_WRAPPER.appendChild(player);
    source = context.createMediaElementSource(audio);
    source.connect(analyser);

function stopEvent (event) {
  event.preventDefault();
  event.stopPropagation();
}

function windowResize () {
  can.width = SANDBOX_WRAPPER.offsetWidth;
  can.height = SANDBOX_WRAPPER.offsetHeight;
}
window.onresize = windowResize;
windowResize();

/**
 * Reduce un array al tamaño deseado haciendo la media
 * de las partes que quedan.
 *
 * Ejemplo para tamaño 2:
 * [1, 1, 2, 2] => [1, 2]
 * [2, 4, 5, 5] => [3, 5]
 */
function reduce (array, size) {
  if (size >= array.length) { return array; }
  var newArray = [],
      step = parseInt(array.length / size);

  for (var i = 0; i < array.length; i += step) {
    var sum = 0;
    for (var j = 0; j < step && (i + j) < array.length; j++) {
      sum += array[i + j];
    }
    newArray.push(parseInt(sum / step));
  }

  return newArray;
}

function renderFrame (audio, analyser) {
  var frequencyData = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(frequencyData);
      frequencyData = reduce(frequencyData, can.width / 10);
      //output.innerHTML = Array.prototype.join.apply(frequencyData, [' ']);

  var colWidth = can.width / frequencyData.length,
      colHeight = can.height / 255;
      ctx.clearRect(0, 0, can.width, can.height);
      ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.6)';

  ctx.beginPath();
  ctx.moveTo(0, can.height);
  for (var i = 1; i < frequencyData.length; i++) {
    ctx.lineTo(i * colWidth, can.height - 10 - frequencyData[i] * colHeight);
  }
  ctx.lineTo(can.width, can.height);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  animationFrame = requestAnimationFrame(function () {
    renderFrame(audio, analyser);
  });
}

function playAudio (url, name) {
  audio.autoplay = player.autoplay = true;
  audio.src = player.src = url;
  audio.play();
  player.play();
  SANDBOX_WRAPPER.querySelector('h1').innerHTML = name;
  cancelAnimationFrame(animationFrame);
  renderFrame(audio, analyser);
}

function dropAudio (event) {
  stopEvent(event);
  var file = event.dataTransfer.files[0],
      url = URL.createObjectURL(file);
      playAudio(url, file.name);
}

SANDBOX_WRAPPER.ondragover = stopEvent
SANDBOX_WRAPPER.ondragenter = stopEvent
SANDBOX_WRAPPER.ondrop = dropAudio
